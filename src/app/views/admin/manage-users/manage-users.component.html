<div class="list-wrapper">

  <!-- ── Page Header ── -->
  <header class="list-header">
    <div class="list-header-left">
      <div class="list-label">Administration · User Management</div>
      <h1 class="list-title">Manage Users</h1>
    </div>
    <div class="list-header-right">
      <div class="search-box">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
        </svg>
        <input type="text" placeholder="Search by name, email, or code…"
          [value]="searchTerm" (input)="onSearchChange($event.target.value)" />
      </div>
      <button class="btn btn-primary" type="button" (click)="openNewUserModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
        </svg>
        Add New User
      </button>
    </div>
  </header>

  <!-- ── Filter Bar ── -->
  <div class="filter-panel" style="margin-bottom: 20px;">
    <div class="filter-panel-body" style="padding: 16px 20px;">
      <div class="filter-group">
        <label class="filter-label">Role</label>
        <select #roleSelect class="filter-input" (change)="onRoleChange(roleSelect.value)">
          <option value="">All Roles</option>
          @for (role of rolesList; track role.roleId) {
            <option [value]="role.roleId.toString()">{{ role.roleName }}</option>
          }
        </select>
      </div>
      <div class="filter-group">
        <label class="filter-label">Status</label>
        <select #statusSelect class="filter-input" (change)="onStatusChange(statusSelect.value)">
          <option value="">All Statuses</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
          <option value="locked">Locked</option>
        </select>
      </div>
    </div>
  </div>

  <!-- ── Table Card ── -->
  <div class="table-card">
    <div style="overflow-x: auto;">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th class="text-center">Department</th>
            <th class="text-center">Role</th>
            <th class="text-center">Last Login</th>
            <th class="text-center">Status</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          @if (getPagedUsers().length > 0) {
            @for (user of getPagedUsers(); track user.accountId) {
            <tr [class.inactive-row]="!user.isActive">
              <td>
                <span class="cell-primary">{{ user.accountName }}</span>
                <div class="cell-sub">{{ user.accountCode }}</div>
              </td>
              <td>
                <a href="mailto:{{ user.email }}" class="cell-mono" style="font-size: 12px; color: var(--accent); text-decoration: none;">
                  {{ user.email }}
                </a>
              </td>
              <td class="text-center">
                {{ user.department || '—' }}
              </td>
              <td class="text-center">
                <span class="ref-chip">{{ getRoleName(user.role) }}</span>
              </td>
              <td class="text-center">
                @if (user.lastLogin) {
                  <span class="cell-mono" style="font-size: 12px;">
                    {{ user.lastLogin | date:'MM/dd/yy' }}<br/>
                    <span style="color: #8a8fa3; font-size: 11px;">{{ user.lastLogin | date:'h:mm a' }}</span>
                  </span>
                } @else {
                  <span class="empty-dash">—</span>
                }
              </td>
              <td class="text-center">
                @if (user.accountLocked) {
                  <span class="status-chip bg-danger">Locked</span>
                } @else if (user.isActive) {
                  <span class="status-chip bg-success">Active</span>
                } @else {
                  <span class="status-chip bg-secondary">Inactive</span>
                }
              </td>
              <td class="text-center">
                <div style="display: inline-flex; gap: 6px; align-items: center;">
                  <button class="action-btn" title="Edit User" (click)="editUser(user)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    Edit
                  </button>

                  @if (!user.accountLocked) {
                    <button class="action-btn"
                      [style.color]="user.isActive ? '#c0392b' : '#0f7b50'"
                      [style.borderColor]="user.isActive ? '#fdecea' : '#e6f7f1'"
                      [style.background]="user.isActive ? '#fdecea' : '#e6f7f1'"
                      [title]="user.isActive ? 'Deactivate User' : 'Activate User'"
                      (click)="toggleUserStatus(user)">
                      @if (user.isActive) {
                        <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <circle cx="12" cy="12" r="10"/><path d="m4.9 4.9 14.2 14.2"/>
                        </svg>
                        Deactivate
                      } @else {
                        <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                        </svg>
                        Activate
                      }
                    </button>
                  }

                  @if (user.accountLocked) {
                    <button class="action-btn"
                      style="color: #0369a1; border-color: #e0f2fe; background: #e0f2fe;"
                      title="Unlock User" (click)="unlockUser(user)">
                      <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 019.9-1"/>
                      </svg>
                      Unlock
                    </button>
                  }
                </div>
              </td>
            </tr>
            }
          } @else {
            <tr>
              <td colspan="7">
                <div class="empty-state">
                  <div class="empty-icon">◻</div>
                  <p>No users found</p>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- Footer -->
    <div class="list-footer">
      <div class="footer-count">
        Showing <strong>{{ getPagedUsers().length }}</strong> of <strong>{{ filteredUsers?.length ?? 0 }}</strong> users
      </div>
      <div class="pagination">
        <button class="page-btn" type="button" (click)="previousPage()" [disabled]="currentPage === 1">←</button>

        @for (page of getPageNumbers(); track page) {
          @if (page === 1 || page === getTotalPages() || (page >= currentPage - 1 && page <= currentPage + 1)) {
            <button class="page-btn" type="button"
              [class.active]="page === currentPage"
              (click)="currentPage = page">{{ page }}</button>
          } @else if (page === currentPage - 2 || page === currentPage + 2) {
            <span class="page-sep">…</span>
          }
        }

        <button class="page-btn" type="button" (click)="nextPage()" [disabled]="currentPage === getTotalPages()">→</button>
      </div>
    </div>
  </div>

</div>

<!-- ── User Modal ── -->
@if (showUserModal) {
  <div class="modal-backdrop" (click)="closeUserModal()"></div>
}
<div class="modal custom-modal" [class.show]="showUserModal" [class.d-block]="showUserModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" (click)="$event.stopPropagation()" role="document">
    <div class="modal-content">
      <div class="modal-header" style="background: #1a3a6b; color: #fff;">
        <h5 class="modal-title" style="font-family: 'Sora', sans-serif; font-weight: 600; font-size: 16px;">
          @if (isEditMode) { Edit User } @else { Create New User }
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeUserModal()" aria-label="Close"></button>
      </div>

      <div class="modal-body" style="padding: 28px;">
        <form [formGroup]="userForm" class="form-professional">
          <div class="row mb-3">
            <div class="col-md-6">
              <label class="filter-label" style="margin-bottom: 6px; display: block;">Full Name</label>
              <input type="text" class="filter-input" style="width: 100%;" formControlName="accountName" placeholder="e.g., John Doe" />
              @if (userForm.get('accountName')?.invalid && userForm.get('accountName')?.touched) {
                <div style="font-size: 11px; color: #c0392b; margin-top: 4px;">Name is required</div>
              }
            </div>
            <div class="col-md-6">
              <label class="filter-label" style="margin-bottom: 6px; display: block;">Department</label>
              <input type="text" class="filter-input" style="width: 100%;" formControlName="department" placeholder="e.g., Sales, Operations" />
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label class="filter-label" style="margin-bottom: 6px; display: block;">Phone</label>
              <input type="text" class="filter-input" style="width: 100%;" formControlName="phone" placeholder="+63 912 345 6789" />
            </div>
            <div class="col-md-6">
              <label class="filter-label" style="margin-bottom: 6px; display: block;">Email</label>
              <input type="email" class="filter-input" style="width: 100%;" formControlName="email" placeholder="user@example.com" />
              @if (userForm.get('email')?.invalid && userForm.get('email')?.touched) {
                <div style="font-size: 11px; color: #c0392b; margin-top: 4px;">Valid email is required</div>
              }
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label class="filter-label" style="margin-bottom: 6px; display: block;">Role</label>
              <select class="filter-input" style="width: 100%;" formControlName="roleId">
                <option value="">Select Role</option>
                @for (role of rolesList; track role.roleId) {
                  <option [value]="role.roleId">{{ role.roleName }}</option>
                }
              </select>
              @if (userForm.get('roleId')?.invalid && userForm.get('roleId')?.touched) {
                <div style="font-size: 11px; color: #c0392b; margin-top: 4px;">Role is required</div>
              }
            </div>
          </div>

          @if (isEditMode) {
            <hr style="border-color: #e2e5ee; margin: 20px 0;" />
            <div class="row mb-3">
              <div class="col-12">
                <label class="filter-label" style="margin-bottom: 10px; display: block;">Password Management</label>
                <button type="button" class="btn btn-ghost" style="margin-bottom: 8px;"
                  (click)="forceResetPassword()" [disabled]="isSubmitting || isResettingPassword">
                  @if (!isResettingPassword) {
                    <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M20 20v-5h-5M4 9a9 9 0 0115 0M20 15a9 9 0 01-15 0"/>
                    </svg>
                    Force Reset Password
                  } @else {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                    Resetting...
                  }
                </button>

                @if (resetPasswordSuccess) {
                  <div style="background: #e6f7f1; color: #0f7b50; border-radius: 6px; padding: 10px 14px; font-size: 13px;">
                    Password reset successfully!
                  </div>
                } @else if (!isResettingPassword) {
                  <div style="font-size: 11.5px; color: #8a8fa3;">Generate a temporary password for the user</div>
                }
              </div>
            </div>
            <hr style="border-color: #e2e5ee; margin: 20px 0;" />
          }
        </form>
      </div>

      <div class="modal-footer" style="border-top: 1px solid #e2e5ee; padding: 16px 24px; gap: 10px;">
        <button type="button" class="btn btn-ghost" (click)="closeUserModal()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="submitUserForm()"
          [disabled]="!userForm.valid || isSubmitting">
          @if (!isSubmitting) {
            {{ isEditMode ? 'Update User' : 'Create User' }}
          } @else {
            <span class="spinner-border spinner-border-sm me-2"></span>
            Submitting...
          }
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ── Toast Notifications ── -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
  <div class="toast align-items-center border-0" [class.show]="showSuccessToast" role="alert">
    <div class="d-flex">
      <div class="toast-body rounded" style="background: #e6f7f1; color: #0f7b50; display: flex; align-items: center; gap: 10px; font-size: 13px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
        </svg>
        <div><strong style="display: block;">Success!</strong>{{ successMessage }}</div>
      </div>
      <button type="button" class="btn-close me-2 m-auto" (click)="showSuccessToast = false" aria-label="Close"></button>
    </div>
  </div>

  <div class="toast align-items-center border-0" [class.show]="showErrorToast" role="alert">
    <div class="d-flex">
      <div class="toast-body rounded" style="background: #fdecea; color: #c0392b; display: flex; align-items: center; gap: 10px; font-size: 13px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/><path d="m15 9-6 6M9 9l6 6"/>
        </svg>
        <div><strong style="display: block;">Error</strong>{{ errorMessage }}</div>
      </div>
      <button type="button" class="btn-close me-2 m-auto" (click)="showErrorToast = false" aria-label="Close"></button>
    </div>
  </div>
</div>