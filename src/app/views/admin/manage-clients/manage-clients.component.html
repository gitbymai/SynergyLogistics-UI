<div class="list-wrapper">

  <!-- ── Page Header ── -->
  <header class="list-header">
    <div class="list-header-left">
      <div class="list-label">Administration · Client Management</div>
      <h1 class="list-title">Manage Clients</h1>
    </div>
    <div class="list-header-right">
      <div class="search-box">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/>
        </svg>
        <input type="text" placeholder="Search by name…"
          [value]="searchTerm" (input)="onSearchChange($event.target.value)" />
      </div>
      <button class="btn btn-primary" type="button" (click)="openNewCustomerModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/>
        </svg>
        Add New Client
      </button>
    </div>
  </header>

  <!-- ── Filter Bar ── -->
  <div class="filter-panel" style="margin-bottom: 20px;">
    <div class="filter-panel-body" style="padding: 16px 20px;">
      <div class="filter-group">
        <label class="filter-label">Status</label>
        <select #statusSelect class="filter-input" (change)="onStatusChange(statusSelect.value)">
          <option value="">All Statuses</option>
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
      </div>
    </div>
  </div>

  <!-- ── Table Card ── -->
  <div class="table-card">
    <div style="overflow-x: auto;">
      <table>
        <thead>
          <tr>
            <th>Client Name</th>
            <th class="text-center">Contact Person</th>
            <th class="text-center">Contact Email</th>
            <th class="text-center">Status</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          @if (getPagedCustomers().length > 0) {
            @for (client of getPagedCustomers(); track client.customerId) {
            <tr [class.inactive-row]="!client.isActive">
              <td>
                <span class="cell-primary">{{ client.customerName }}</span>
              </td>
              <td class="text-center">
                {{ client.contactPerson || '—' }}
              </td>
              <td class="text-center">
                @if (client.emailAddress) {
                  <a href="mailto:{{ client.emailAddress }}" class="cell-mono"
                    style="font-size: 12px; color: var(--accent); text-decoration: none;">
                    {{ client.emailAddress }}
                  </a>
                } @else {
                  <span class="empty-dash">—</span>
                }
              </td>
              <td class="text-center">
                @if (client.isActive) {
                  <span class="status-chip bg-success">Active</span>
                } @else {
                  <span class="status-chip bg-secondary">Inactive</span>
                }
              </td>
              <td class="text-center">
                <div style="display: inline-flex; gap: 6px; align-items: center;">
                  <button class="action-btn" title="Edit Client" (click)="editCustomer(client)">
                    <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    Edit
                  </button>
                  <button class="action-btn"
                    [style.color]="client.isActive ? '#c0392b' : '#0f7b50'"
                    [style.borderColor]="client.isActive ? '#fdecea' : '#e6f7f1'"
                    [style.background]="client.isActive ? '#fdecea' : '#e6f7f1'"
                    [title]="client.isActive ? 'Deactivate Client' : 'Activate Client'"
                    (click)="toggleClientStatus(client)">
                    @if (client.isActive) {
                      <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/><path d="m4.9 4.9 14.2 14.2"/>
                      </svg>
                      Deactivate
                    } @else {
                      <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
                      </svg>
                      Activate
                    }
                  </button>
                </div>
              </td>
            </tr>
            }
          } @else {
            <tr>
              <td colspan="5">
                <div class="empty-state">
                  <div class="empty-icon">◻</div>
                  <p>No clients found</p>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- Footer -->
    <div class="list-footer">
      <div class="footer-count">
        Showing <strong>{{ getPagedCustomers().length }}</strong> of <strong>{{ filterCustomers?.length ?? 0 }}</strong> clients
      </div>
      <div class="pagination">
        <button class="page-btn" type="button" (click)="previousPage()" [disabled]="currentPage === 1">←</button>

        @for (page of getPageNumbers(); track page) {
          @if (page === 1 || page === getTotalPages() || (page >= currentPage - 1 && page <= currentPage + 1)) {
            <button class="page-btn" type="button"
              [class.active]="page === currentPage"
              (click)="currentPage = page">{{ page }}</button>
          } @else if (page === currentPage - 2 || page === currentPage + 2) {
            <span class="page-sep">…</span>
          }
        }

        <button class="page-btn" type="button" (click)="nextPage()" [disabled]="currentPage === getTotalPages()">→</button>
      </div>
    </div>
  </div>

</div>

<!-- ── Client Modal ── -->
@if (showModal) {
  <div class="modal-backdrop" (click)="closeCustomerModal()"></div>
}
<div class="modal custom-modal" [class.show]="showModal" [class.d-block]="showModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" (click)="$event.stopPropagation()" role="document">
    <div class="modal-content">
      <div class="modal-header" style="background: #1a3a6b; color: #fff;">
        <h5 class="modal-title" style="font-family: 'Sora', sans-serif; font-weight: 600; font-size: 16px;">
          @if (isEditMode) { Edit Client } @else { Create New Client }
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeCustomerModal()" aria-label="Close"></button>
      </div>

      <div class="modal-body" style="padding: 28px;">
        <form [formGroup]="customerForm" class="form-professional">

          <div class="row mb-3">
            <div class="col-md-6">
              <label class="filter-label" style="margin-bottom: 6px; display: block;">Client Name</label>
              <input type="text" class="filter-input" style="width: 100%;" formControlName="customerName" placeholder="e.g., DMCI" />
              @if (customerForm.get('customerName')?.invalid && customerForm.get('customerName')?.touched) {
                <div style="font-size: 11px; color: #c0392b; margin-top: 4px;">Client Name is required</div>
              }
            </div>
            <div class="col-md-6">
              <label class="filter-label" style="margin-bottom: 6px; display: block;">TIN Number</label>
              <input type="text" class="filter-input" style="width: 100%;" formControlName="taxIdentificationNumber" placeholder="e.g., 0003-3042-0214" />
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-4">
              <label class="filter-label" style="margin-bottom: 6px; display: block;">Contact Person</label>
              <input type="text" class="filter-input" style="width: 100%;" formControlName="contactPerson" placeholder="e.g., John Doe" />
            </div>
            <div class="col-md-4">
              <label class="filter-label" style="margin-bottom: 6px; display: block;">Contact Number</label>
              <input type="text" class="filter-input" style="width: 100%;" formControlName="contactNumber" placeholder="+63 912 345 6789" />
            </div>
            <div class="col-md-4">
              <label class="filter-label" style="margin-bottom: 6px; display: block;">Email</label>
              <input type="email" class="filter-input" style="width: 100%;" formControlName="emailAddress" placeholder="user@example.com" />
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label class="filter-label" style="margin-bottom: 6px; display: block;">State</label>
              <input type="text" class="filter-input" style="width: 100%;" formControlName="state" placeholder="e.g., Manila, Batangas" />
            </div>
            <div class="col-md-6">
              <label class="filter-label" style="margin-bottom: 6px; display: block;">City</label>
              <input type="text" class="filter-input" style="width: 100%;" formControlName="city" placeholder="e.g., Makati City, Batangas City" />
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-12">
              <label class="filter-label" style="margin-bottom: 6px; display: block;">Address</label>
              <textarea class="filter-input" style="width: 100%; resize: vertical; min-height: 80px;"
                formControlName="mainAddress" rows="3"
                placeholder="Add main address here" maxlength="900"></textarea>
              @if (customerForm.get('mainAddress')?.invalid && customerForm.get('mainAddress')?.touched) {
                <div style="font-size: 11px; color: #c0392b; margin-top: 4px;">Maximum 900 characters</div>
              }
              <div style="font-size: 11px; color: #8a8fa3; margin-top: 4px;">
                {{ customerForm.get('mainAddress')?.value?.length || 0 }} / 900 characters
              </div>
            </div>
          </div>

          <div class="row mb-3">
            <div class="col-md-6">
              <label class="filter-label" style="margin-bottom: 6px; display: block;">Client Category</label>
              <select class="filter-input" style="width: 100%;" formControlName="optionClientCategoryId">
                <option [value]="0">Select Client Category</option>
                @for (client of clientType; track client.optionId) {
                  <option [value]="client.optionId">{{ client.value }}</option>
                }
              </select>
            </div>
            <div class="col-md-6">
              <label class="filter-label" style="margin-bottom: 6px; display: block;">Client Industry</label>
              <select class="filter-input" style="width: 100%;" formControlName="optionIndustryId">
                <option [value]="0">Select Client Industry</option>
                @for (client of clientIndustry; track client.optionId) {
                  <option [value]="client.optionId">{{ client.value }}</option>
                }
              </select>
            </div>
          </div>

        </form>
      </div>

      <div class="modal-footer" style="border-top: 1px solid #e2e5ee; padding: 16px 24px; gap: 10px;">
        <button type="button" class="btn btn-ghost" (click)="closeCustomerModal()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="submitCustomerForm()"
          [disabled]="!customerForm.valid || isSubmitting">
          @if (!isSubmitting) {
            {{ isEditMode ? 'Update Client' : 'Create Client' }}
          } @else {
            <span class="spinner-border spinner-border-sm me-2"></span>
            Submitting...
          }
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ── Toast Notifications ── -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
  <div class="toast align-items-center border-0" [class.show]="showSuccessToast" role="alert">
    <div class="d-flex">
      <div class="toast-body rounded" style="background: #e6f7f1; color: #0f7b50; display: flex; align-items: center; gap: 10px; font-size: 13px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
        </svg>
        <div><strong style="display: block;">Success!</strong>{{ successMessage }}</div>
      </div>
      <button type="button" class="btn-close me-2 m-auto" (click)="showSuccessToast = false" aria-label="Close"></button>
    </div>
  </div>

  <div class="toast align-items-center border-0" [class.show]="showErrorToast" role="alert">
    <div class="d-flex">
      <div class="toast-body rounded" style="background: #fdecea; color: #c0392b; display: flex; align-items: center; gap: 10px; font-size: 13px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/><path d="m15 9-6 6M9 9l6 6"/>
        </svg>
        <div><strong style="display: block;">Error</strong>{{ errorMessage }}</div>
      </div>
      <button type="button" class="btn-close me-2 m-auto" (click)="showErrorToast = false" aria-label="Close"></button>
    </div>
  </div>
</div>