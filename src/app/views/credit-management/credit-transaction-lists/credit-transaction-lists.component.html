<div class="card my-4 shadow-sm">
    <div class="card-header bg-primary text-white">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0">
                <i class="cil-list me-2"></i> Credit Transactions - {{ resourceName }}
            </h4>
            <div class="d-flex gap-2">
                <button class="btn btn-light btn-sm" type="button" (click)="goBack()">
                    <i class="cil-arrow-left me-2"></i> Back to Credits
                </button>
                <button class="btn btn-light btn-sm" type="button" (click)="openNewTransactionModal()">
                    <i class="cil-plus me-2"></i> Add Transaction
                </button>
            </div>
        </div>
    </div>

    <div class="card-body">
        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="credit-summary-card total">
                    <div class="card-icon">
                        <i class="cil-arrow-top"></i>
                    </div>
                    <div class="card-content">
                        <div class="card-label">Total Credits</div>
                        <div class="card-value">{{ getTotalCredits() | number:'1.2-2' }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="credit-summary-card remaining">
                    <div class="card-icon">
                        <i class="cil-wallet"></i>
                    </div>
                    <div class="card-content">
                        <div class="card-label">Current Balance</div>
                        <div class="card-value">{{ currentBalance | number:'1.2-2' }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="credit-summary-card used">
                    <div class="card-icon">
                        <i class="cil-arrow-bottom"></i>
                    </div>
                    <div class="card-content">
                        <div class="card-label">Total Debits</div>
                        <div class="card-value">{{ getTotalDebits() | number:'1.2-2' }}</div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="credit-summary-card total">
                    <div class="card-icon">
                        <i class="cil-chart-line"></i>
                    </div>
                    <div class="card-content">
                        <div class="card-label">Total Transactions</div>
                        <div class="card-value">{{ transactions.length }}</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transactions Table -->
        <div class="table-responsive">
            <table class="table table-hover table-custom">
                <thead>
                    <tr>
                        <th>
                            <i class="cil-layers me-2"></i> Transaction Type
                        </th>
                        <th class="text-center">
                            <i class="cil-dollar me-2"></i> Amount
                        </th>
                        <th>
                            <i class="cil-notes me-2"></i> Reference #
                        </th>
                        <th class="text-center">
                            <i class="cil-calendar me-2"></i> Transaction Date
                        </th>
                        <th>
                            <i class="cil-user me-2"></i> Created By
                        </th>
                        <th class="text-center">
                            <i class="cil-settings me-2"></i> Actions
                        </th>
                    </tr>
                </thead>
                <tbody>
                    @if(getPagedTransactions().length > 0) {
                    @for(transaction of getPagedTransactions(); track transaction.transactionId) {
                    <tr [class.inactive-row]="!transaction.isActive">
                        <td>
                            <div class="d-flex align-items-center">
                                @if(isDebitTransaction(transaction.optionResourceTransactionTypeId)) {
                                <span class="badge bg-danger me-2">
                                    <i class="cil-arrow-bottom"></i>
                                </span>
                                } @else {
                                <span class="badge bg-success me-2">
                                    <i class="cil-arrow-top"></i>
                                </span>
                                }
                                <span>{{ transaction.resourceTransactionTypeName
                                    }}</span>
                            </div>
                        </td>
                        <td class="text-center">
                            @if(isDebitTransaction(transaction.optionResourceTransactionTypeId)) {
                            <span class="text-danger fw-bold">-{{ transaction.amount | number:'1.2-2' }}</span>
                            } @else {
                            <span class="text-success fw-bold">+{{ transaction.amount | number:'1.2-2' }}</span>
                            }
                        </td>
                        <td>
                            @if(transaction.referenceNumber) {
                            <span>{{ transaction.referenceNumber }}</span>
                            } @else {
                            <span class="text-muted">-</span>
                            }
                        </td>
                        <td class="text-center">
                            @if(transaction.createdDate) {
                            {{ transaction.createdDate | date:'MM/dd/yy h:mm a' }}
                            } @else {
                            <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            @if(transaction.createdByName) {
                            <span>{{ transaction.createdByName }}</span>
                            } @else {
                            <span class="text-muted">-</span>
                            }
                        </td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-sm btn-primary-outline" title="View Details"
                                    (click)="viewTransactionDetails(transaction)">
                                    <i class="cil-info"></i>
                                </button>
                                <button class="btn btn-sm btn-warning" title="Edit Transaction"
                                    (click)="editTransaction(transaction)">
                                    <i class="cil-pencil"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    }
                    } @else {
                    <tr>
                        <td colspan="10" class="text-center text-muted py-4">
                            <i class="cil-search me-2" style="font-size: 2rem;"></i>
                            <div class="mt-2">No transactions found</div>
                        </td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item" [class.disabled]="currentPage === 1">
                    <button class="page-link" type="button" (click)="previousPage()" [disabled]="currentPage === 1">
                        <i class="cil-arrow-left me-1"></i> Previous
                    </button>
                </li>
                @for(page of getPageNumbers(); track page) {
                <li class="page-item" [class.active]="page === currentPage">
                    <button class="page-link" type="button" (click)="currentPage = page">
                        {{ page }}
                    </button>
                </li>
                }
                <li class="page-item" [class.disabled]="currentPage === getTotalPages()">
                    <button class="page-link" type="button" (click)="nextPage()"
                        [disabled]="currentPage === getTotalPages()">
                        Next <i class="cil-arrow-right ms-1"></i>
                    </button>
                </li>
            </ul>
        </nav>
    </div>
</div>

<!-- Add Transaction Modal -->
@if (showTransactionModal) {
<div class="modal-backdrop" (click)="closeTransactionModal()"></div>
}
<div class="modal custom-modal" [class.show]="showTransactionModal" [class.d-block]="showTransactionModal" tabindex="-1"
    role="dialog">
    <div class="modal-dialog modal-dialog-centered modal-lg" (click)="$event.stopPropagation()" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="cil-plus me-2"></i> Add New Transaction
                </h5>
                <button type="button" class="btn-close btn-close-white" (click)="closeTransactionModal()"
                    aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <form [formGroup]="transactionForm" class="form-professional">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">
                                <i class="cil-layers me-1"></i> Transaction Type <span class="text-danger">*</span>
                            </label>
                            <select class="form-select form-control-custom"
                                formControlName="optionResourceTransactionTypeId">
                                <option value="">Select Transaction Type</option>
                                @for(type of transactionTypes; track type.optionId) {
                                <option [value]="type.optionId">{{ type.value }}</option>
                                }
                            </select>
                            @if (transactionForm.get('optionResourceTransactionTypeId')?.invalid &&
                            transactionForm.get('optionResourceTransactionTypeId')?.touched) {
                            <div class="text-danger small mt-1">Transaction type is required</div>
                            }
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">
                                <i class="cil-dollar me-1"></i> Amount <span class="text-danger">*</span>
                            </label>
                            <input type="number" class="form-control form-control-custom" formControlName="amount"
                                placeholder="e.g., 100.00" min="0.01" step="0.01" />
                            @if (transactionForm.get('amount')?.invalid && transactionForm.get('amount')?.touched) {
                            <div class="text-danger small mt-1">Amount is required (0.01 - 9999999999999999.99)</div>
                            }
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">
                                <i class="cil-notes me-1"></i> Reference Number
                            </label>
                            <input type="text" class="form-control form-control-custom"
                                formControlName="referenceNumber" placeholder="e.g., INV-2024-001" maxlength="50" />
                            @if (transactionForm.get('referenceNumber')?.invalid &&
                            transactionForm.get('referenceNumber')?.touched) {
                            <div class="text-danger small mt-1">Maximum 50 characters</div>
                            }
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">
                                <i class="cil-note-add me-1"></i> Notes
                            </label>
                            <textarea class="form-control form-control-custom" formControlName="notes" rows="3"
                                placeholder="Additional notes or comments..." maxlength="1000"></textarea>
                            @if (transactionForm.get('notes')?.invalid && transactionForm.get('notes')?.touched) {
                            <div class="text-danger small mt-1">Maximum 1000 characters</div>
                            }
                            <small class="text-muted">
                                {{ transactionForm.get('notes')?.value?.length || 0 }} / 1000 characters
                            </small>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closeTransactionModal()">
                    <i class="cil-x me-2"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" (click)="submitTransactionForm()"
                    [disabled]="!transactionForm.valid || isSubmitting">
                    @if (!isSubmitting) {
                    <span>
                        <i class="cil-check me-2"></i> Create Transaction
                    </span>
                    }
                    @if (isSubmitting) {
                    <span>
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        Submitting...
                    </span>
                    }
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Transaction Modal -->
@if (showEditTransactionModal) {
<div class="modal-backdrop" (click)="closeEditTransactionModal()"></div>
}
<div class="modal custom-modal" [class.show]="showEditTransactionModal" [class.d-block]="showEditTransactionModal" tabindex="-1"
    role="dialog">
    <div class="modal-dialog modal-dialog-centered modal-lg" (click)="$event.stopPropagation()" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning text-dark">
                <h5 class="modal-title">
                    <i class="cil-pencil me-2"></i> Edit Transaction
                </h5>
                <button type="button" class="btn-close" (click)="closeEditTransactionModal()"
                    aria-label="Close"></button>
            </div>

            <div class="modal-body">
                <form [formGroup]="editTransactionForm" class="form-professional">
                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">
                                <i class="cil-layers me-1"></i> Transaction Type <span class="text-danger">*</span>
                            </label>
                            <select class="form-select form-control-custom"
                                formControlName="optionResourceTransactionTypeId">
                                <option value="">Select Transaction Type</option>
                                @for(type of transactionTypes; track type.optionId) {
                                <option [value]="type.optionId">{{ type.value }}</option>
                                }
                            </select>
                            @if (editTransactionForm.get('optionResourceTransactionTypeId')?.invalid &&
                            editTransactionForm.get('optionResourceTransactionTypeId')?.touched) {
                            <div class="text-danger small mt-1">Transaction type is required</div>
                            }
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">
                                <i class="cil-dollar me-1"></i> Amount <span class="text-danger">*</span>
                            </label>
                            <input type="number" class="form-control form-control-custom" formControlName="amount"
                                placeholder="e.g., 100.00" min="0.01" step="0.01" />
                            @if (editTransactionForm.get('amount')?.invalid && editTransactionForm.get('amount')?.touched) {
                            <div class="text-danger small mt-1">Amount is required (0.01 - 9999999999999999.99)</div>
                            }
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">
                                <i class="cil-notes me-1"></i> Reference Number
                            </label>
                            <input type="text" class="form-control form-control-custom"
                                formControlName="referenceNumber" placeholder="e.g., INV-2024-001" maxlength="50" />
                            @if (editTransactionForm.get('referenceNumber')?.invalid &&
                            editTransactionForm.get('referenceNumber')?.touched) {
                            <div class="text-danger small mt-1">Maximum 50 characters</div>
                            }
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-12">
                            <label class="form-label">
                                <i class="cil-note-add me-1"></i> Notes
                            </label>
                            <textarea class="form-control form-control-custom" formControlName="notes" rows="3"
                                placeholder="Additional notes or comments..." maxlength="1000"></textarea>
                            @if (editTransactionForm.get('notes')?.invalid && editTransactionForm.get('notes')?.touched) {
                            <div class="text-danger small mt-1">Maximum 1000 characters</div>
                            }
                            <small class="text-muted">
                                {{ editTransactionForm.get('notes')?.value?.length || 0 }} / 1000 characters
                            </small>
                        </div>
                    </div>
                </form>
            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="closeEditTransactionModal()">
                    <i class="cil-x me-2"></i> Cancel
                </button>
                <button type="button" class="btn btn-warning" (click)="submitEditTransactionForm()"
                    [disabled]="!editTransactionForm.valid || isSubmitting">
                    @if (!isSubmitting) {
                    <span>
                        <i class="cil-save me-2"></i> Update Transaction
                    </span>
                    }
                    @if (isSubmitting) {
                    <span>
                        <span class="spinner-border spinner-border-sm me-2"></span>
                        Updating...
                    </span>
                    }
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Transaction Details Modal -->
@if (showDetailsModal) {
<div class="modal-backdrop" (click)="closeDetailsModal()"></div>
}
<div class="modal custom-modal" [class.show]="showDetailsModal" [class.d-block]="showDetailsModal" tabindex="-1"
    role="dialog">
    <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()" role="document">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">Transaction Details</h5>
                <button type="button" class="btn-close" (click)="closeDetailsModal()" aria-label="Close"></button>
            </div>

            <div class="modal-body px-4">
                @if(selectedTransaction) {
                <!-- Amount -->
                <div class="text-center mb-4">
                    @if(isDebitTransaction(selectedTransaction.optionResourceTransactionTypeId)) {
                    <div class="display-6 text-danger fw-bold">-{{ selectedTransaction.amount | number:'1.2-2' }}</div>
                    } @else {
                    <div class="display-6 text-success fw-bold">+{{ selectedTransaction.amount | number:'1.2-2' }}</div>
                    }
                    <div class="text-muted small mt-1">{{ selectedTransaction.transactionTypeName }}</div>
                </div>

                <!-- Balance Info -->
                <div class="d-flex justify-content-between mb-4 pb-3 border-bottom">
                    <div>
                        <div class="text-muted small">Balance Before</div>
                        <div class="fw-medium">{{ selectedTransaction.balanceBefore | number:'1.2-2' }}</div>
                    </div>
                    <div class="text-end">
                        <div class="text-muted small">Balance After</div>
                        <div class="fw-medium">{{ selectedTransaction.balanceAfter | number:'1.2-2' }}</div>
                    </div>
                </div>

                <div class="mb-3">
                    <div class="text-muted small">Reference Number</div>
                    <div>{{ selectedTransaction.referenceNumber }}</div>
                </div>

                <!-- Notes -->
                <div class="mb-3">
                    <div class="text-muted small">Notes</div>
                    <div>{{ selectedTransaction.notes }}</div>
                </div>

                <div class="mt-4 pt-3 border-top">
                    <div class="d-flex justify-content-between text-muted small mb-2">
                        <span>{{ selectedTransaction.createdByName || 'Unknown' }}</span>
                        <span>{{ selectedTransaction.createdDate | date: 'MM/dd/yy h:mm a' }}</span>
                    </div>
                    @if(selectedTransaction.modifiedByName && selectedTransaction.modifiedDate) {
                    <div class="d-flex justify-content-between text-muted small">
                        <span>Modified by {{ selectedTransaction.modifiedByName }}</span>
                        <span>{{ selectedTransaction.modifiedDate | date: 'MM/dd/yy h:mm a' }}</span>
                    </div>
                    }
                </div>
                }
            </div>

            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" (click)="closeDetailsModal()">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>


<!-- Toast Notifications -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
    <!-- Success Toast -->
    <div class="toast align-items-center border-0" [class.show]="showSuccessToast" role="alert" aria-live="assertive"
        aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body bg-success text-white rounded">
                <div class="d-flex align-items-center">
                    <i class="cil-check-circle me-2" style="font-size: 1.5rem;"></i>
                    <div>
                        <strong class="d-block">Success!</strong>
                        <span>{{ successMessage }}</span>
                    </div>
                </div>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" (click)="showSuccessToast = false"
                aria-label="Close"></button>
        </div>
    </div>

    <!-- Error Toast -->
    <div class="toast align-items-center border-0" [class.show]="showErrorToast" role="alert" aria-live="assertive"
        aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body bg-danger text-white rounded">
                <div class="d-flex align-items-center">
                    <i class="cil-x-circle me-2" style="font-size: 1.5rem;"></i>
                    <div>
                        <strong class="d-block">Error</strong>
                        <span>{{ errorMessage }}</span>
                    </div>
                </div>
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" (click)="showErrorToast = false"
                aria-label="Close"></button>
        </div>
    </div>
</div>