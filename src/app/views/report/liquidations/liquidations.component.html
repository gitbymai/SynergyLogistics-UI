<div class="report-wrapper">

  <!-- ── Report Header ── -->
  <header class="report-header">
    <div class="report-header-left">
      <div class="report-label">Financial Operations · Freight Management</div>
      <h1 class="report-title">Actual Refunds Report</h1>
      <p class="report-subtitle">Processed refunds against submitted charge codes and job references</p>
    </div>
    <div class="report-header-right">
      <div class="report-meta">
        Generated: {{ today | date:'MMMM d, yyyy' }}<br />
        Period: {{ filters.dateFrom || 'All time' }} — {{ filters.dateTo || 'Present' }}<br />
        Records: {{ filteredRefunds.length }}
      </div>
    </div>
  </header>

  <!-- ── KPI Summary Cards ── -->
  <!-- NOTE: Wire up these values to your component properties -->
  <div class="kpi-row">
    <div class="kpi-card accent">
      <div class="kpi-label">Total Refund Value</div>
      <div class="kpi-value">{{ calculateTotalRefundAmount() }}</div>
      <div class="kpi-note">Across all currencies</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Total Records</div>
      <div class="kpi-value">{{ filteredRefunds.length }}</div>
      <div class="kpi-note">{{ filteredRefunds.length !== refunds.length ? 'Filtered from ' + refunds.length : 'All
        records' }}</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">Avg. Refund Amount</div>
      <div class="kpi-value">{{ calculateAverageRefundAmount() }}</div>
      <div class="kpi-note">Per transaction</div>
    </div>
    <div class="kpi-card">
      <div class="kpi-label">With Reference #</div>
      <div class="kpi-value">{{ countWithReference() }}</div>
      <div class="kpi-note">Tracked refunds</div>
    </div>
  </div>

  <!-- ── Toolbar ── -->
  <div class="toolbar">
    <div class="toolbar-left">
      <div class="search-box">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8" />
          <path d="m21 21-4.35-4.35" />
        </svg>
        <input type="text" placeholder="Search by job code, charge code, reference…" [(ngModel)]="searchTerm"
          (input)="onSearchChange()" />
      </div>
    </div>
    <div class="toolbar-right">
      <button class="btn btn-ghost" (click)="toggleFilters()">
        <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="none" viewBox="0 0 24 24"
          stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 4h18M7 10h10M11 16h2" />
        </svg>
        {{ showFilters ? 'Hide Filters' : 'Filters' }}
        @if (hasActiveFilters()) {
        <span class="badge">{{ activeFilterCount() }}</span>
        }
      </button>
      <button class="btn btn-ghost" (click)="exportReport()">
        <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="none" viewBox="0 0 24 24"
          stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round"
            d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5 5 5-5M12 15V3" />
        </svg>
        Export
      </button>
    </div>
  </div>

  <!-- ── Filter Panel ── -->
  @if (showFilters) {
  <div class="filter-panel">
    <div class="filter-panel-header">
      <span>Filter Options</span>
      <button class="btn btn-ghost" style="padding: 5px 12px; font-size: 11.5px;" (click)="clearFilters()">Clear
        All</button>
    </div>
    <div class="filter-panel-body">
      <div class="filter-group">
        <label class="filter-label">Date From</label>
        <input type="date" class="filter-input" [(ngModel)]="filters.dateFrom" (change)="onDateFromChange()" />
      </div>
      <div class="filter-group">
        <label class="filter-label">Date To</label>
        <input type="date" class="filter-input" [(ngModel)]="filters.dateTo" [min]="filters.dateFrom" [max]="maxDateTo"
          (change)="onDateToChange()" />
        @if (dateRangeError) {
        <span style="font-size: 11px; color: var(--red); margin-top: 4px;">
          Date range cannot exceed 1 month.
        </span>
        }
      </div>
      <div class="filter-group" style="justify-content: flex-end;">
        <label class="filter-label">&nbsp;</label>
        <button class="btn btn-primary" (click)="generateReport()" [disabled]="isLoading">
          @if (isLoading) {
          <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="2" class="spin">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M12 3v3m0 12v3m9-9h-3M6 12H3m15.364-6.364-2.121 2.121M8.757 15.243l-2.121 2.121M18.364 18.364l-2.121-2.121M8.757 8.757 6.636 6.636" />
          </svg>
          Generating...
          } @else {
          <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M16 4h2a2 2 0 012 2v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6a2 2 0 012-2h2" />
            <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
          </svg>
          Generate Report
          }
        </button>
      </div>
    </div>
  </div>
  }

  <!-- ── Data Table ── -->
  <div class="table-card">
    <div style="overflow-x: auto;">
      <table>
        <thead>
          <tr>
            <th>Job Code</th>
            <th>Airwaybill / Bill of Lading</th>
            <th>Charge Code</th>
            <th class="right">Requested Amount</th>
            <th class="right">Refund Amount</th>
            <th class="center">Reference #</th>
            <th class="right">Refund Date</th>
          </tr>
        </thead>
        <tbody>
          @if (paginatedRefunds.length > 0) {
          @for (refund of paginatedRefunds; track refund.refundId) {
          <tr>
            <td>
              <span class="cell-primary cell-mono">{{ refund.jobCode }}</span>
            </td>
            <td>
              @if (refund.houseBillLading && refund.masterBillLading) {
              <div class="waybill-pair">
                {{ refund.houseBillLading }}
                <span>{{ refund.masterBillLading }}</span>
              </div>
              } @else if (refund.houseAirWaybill && refund.masterAirWaybill) {
              <div class="waybill-pair">
                {{ refund.houseAirWaybill }}
                <span>{{ refund.masterAirWaybill }}</span>
              </div>
              } @else {
              <span style="color: var(--rule); font-size: 13px;">—</span>
              }
            </td>
            <td>
              <span class="cell-primary">{{ refund.chargeCode }}</span>
              @if (refund.description) {
              <div class="cell-sub">{{ refund.description }}</div>
              }
            </td>
            <td class="right">
              <span class="cell-mono" style="color: var(--ink-soft);">
                {{ refund.amount | currency:refund.currencyCode }}
              </span>
            </td>
            <td class="right">
              <span class="amount-positive">{{ refund.refundAmount | currency:refund.currencyCode }}</span>
            </td>
            <td class="center">
              @if (refund.referenceNumber) {
              <span class="ref-chip">{{ refund.referenceNumber }}</span>
              } @else {
              <span style="color: var(--rule); font-size: 13px;">—</span>
              }
            </td>
            <td class="right">
              <span class="cell-mono" style="font-size: 12px;">
                @if (refund.createdDate) {
                {{ refund.createdDate | date:'MM/dd/yy' }}<br />
                <span style="color: var(--ink-muted); font-size: 11px;">{{ refund.createdDate | date:'h:mm a' }}</span>
                } @else {
                <span style="color: var(--rule);">—</span>
                }
              </span>
            </td>
          </tr>
          }
          } @else {
          <tr>
            <td colspan="7">
              <div class="empty-state">
                <div class="empty-icon">◻</div>
                <p>No refunds match your current filters</p>
              </div>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>

    <!-- Footer row -->
    <div class="report-footer">
      <div class="footer-count">
        Showing <strong>{{ paginatedRefunds.length }}</strong> of <strong>{{ filteredRefunds.length }}</strong> refunds
      </div>
      @if (filteredRefunds.length > 0) {
      <div>
        <span class="footer-total-label">Total Refund Amount</span>
        <span class="footer-total">{{ calculateTotalRefundAmount() }}</span>
      </div>
      }
    </div>

    <!-- Pagination -->
    <div class="pagination">
      <button class="page-btn" type="button" (click)="goToPage(currentPage - 1)" [disabled]="currentPage === 1">
        ←
      </button>

      @for (page of [].constructor(totalPages()); track page; let i = $index) {
      @if (i + 1 === 1 || i + 1 === totalPages() || (i + 1 >= currentPage - 1 && i + 1 <= currentPage + 1)) { <button
        class="page-btn" type="button" [class.active]="i + 1 === currentPage" (click)="goToPage(i + 1)">
        {{ i + 1 }}
        </button>
        } @else if (i + 1 === currentPage - 2 || i + 1 === currentPage + 2) {
        <span class="page-sep">…</span>
        }
        }

        <button class="page-btn" type="button" (click)="goToPage(currentPage + 1)"
          [disabled]="currentPage === totalPages()">
          →
        </button>
    </div>
  </div>

</div>