<div class="list-wrapper">

  <!-- ── Page Header ── -->
  <header class="list-header">
    <div class="list-header-left">
      <div class="list-label">Operations · Job Management</div>
      <h1 class="list-title">
        Charges Management
        <span class="ref-chip" style="font-size: 14px; vertical-align: middle; margin-left: 8px;">{{ jobCode }}</span>
      </h1>
    </div>
    <div class="list-header-right">
      <button class="btn btn-primary" type="button" (click)="openAddModal()">
        <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="none" viewBox="0 0 24 24"
          stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
        </svg>
        Add Charge
      </button>
    </div>
  </header>

  <!-- ── Table Card ── -->
  <div class="table-card">

    <!-- Loading -->
    @if (isLoading) {
    <div style="text-align: center; padding: 64px 32px; color: var(--ink-muted);">
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"
        stroke="currentColor" stroke-width="2" class="spin" style="margin-bottom: 12px;">
        <path stroke-linecap="round" stroke-linejoin="round"
          d="M12 3v3m0 12v3m9-9h-3M6 12H3m15.364-6.364-2.121 2.121M8.757 15.243l-2.121 2.121M18.364 18.364l-2.121-2.121M8.757 8.757 6.636 6.636" />
      </svg>
      <p style="font-size: 13px;">Loading charges...</p>
    </div>
    }

    @if (!isLoading) {
    <div style="overflow-x: auto;">
      <table>
        <thead>
          <tr>
            <th>Code</th>
            <th>Item</th>
            <th class="text-center">Status</th>
            <th class="text-right">Charge Amt</th>
            <th class="text-right">Calc. Charge</th>
            <th class="text-right">Selling Amt</th>
            <th class="text-right">Calc. Selling</th>
            <th>Assigned Processor</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (charge of filteredCharges; track charge) {
          <tr>
            <td>
              <span class="cell-mono" style="color: var(--accent); font-weight: 600;">
                {{ charge.chargeCode }}
              </span>
            </td>
            <td>
              <span class="cell-primary">{{ charge.chargeSubCategoryName }}</span>
            </td>
            <td class="text-center">
              <span class="status-chip" [ngClass]="getStatusClass(charge.chargeTransactionStatus || '')">
                {{ charge.chargeTransactionStatus }}
              </span>
            </td>
            <td class="text-right">
              <span class="cell-mono" style="font-size: 12px;">
                {{ charge.currencyCode }} {{ charge.amount | number:'1.2-2' }}
              </span>
            </td>
            <td class="text-right">
              <span class="amount-positive">PHP {{ charge.calculatedAmount | number:'1.2-2' }}</span>
            </td>
            <td class="text-right">
              <span class="cell-mono" style="font-size: 12px;">
                {{ charge.currencyCode }} {{ charge.amountSelling | number:'1.2-2' }}
              </span>
            </td>
            <td class="text-right">
              <span class="amount-positive">PHP {{ charge.calculatedSellingAmount | number:'1.2-2' }}</span>
            </td>
            <td>
              <span class="cell-sub" style="font-size: 12px;">{{ charge.processorOwnerName ?? 'UNASSIGNED' }}</span>
            </td>
            <td class="text-center">
              <div style="display: inline-flex; gap: 4px; align-items: center;">
                @if (charge.chargeTransactionStatus === 'FOR APPROVAL') {
                <button class="action-btn" style="color: #0369a1; border-color: #e0f2fe; background: #e0f2fe;"
                  (click)="openReviewModal(charge)" title="Review Request">
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                  </svg>
                  Review
                </button>
                }
                <button class="action-btn" (click)="openEditModal(charge)" title="Edit Charge"
                  [disabled]="charge.chargeTransactionStatus !== 'APPROVED'"
                  [style.opacity]="charge.chargeTransactionStatus !== 'APPROVED' ? '0.4' : '1'"
                  [style.pointer-events]="charge.chargeTransactionStatus !== 'APPROVED' ? 'none' : 'auto'">
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                  </svg>
                  Edit
                </button>
                <button class="action-btn" style="color: var(--red); border-color: #fdecea; background: #fdecea;"
                  (click)="deleteCharge(charge)" title="Cancel Charge"
                  [disabled]="charge.chargeTransactionStatus !== 'APPROVED'"
                  [style.opacity]="charge.chargeTransactionStatus !== 'APPROVED' ? '0.4' : '1'"
                  [style.pointer-events]="charge.chargeTransactionStatus !== 'APPROVED' ? 'none' : 'auto'">
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                  </svg>
                  Cancel
                </button>
                <button class="action-btn" (click)="openViewModal(charge)" title="View Details">
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24"
                    stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                      d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    <circle cx="12" cy="12" r="3" />
                  </svg>
                  View
                </button>
              </div>
            </td>
          </tr>
          }
          @if (filteredCharges.length === 0) {
          <tr>
            <td colspan="10">
              <div class="empty-state">
                <div class="empty-icon">◻</div>
                <p>No charges found</p>
              </div>
            </td>
          </tr>
          }
        </tbody>
        @if (filteredCharges.length > 0) {
        <tfoot>
          <tr>
            <td colspan="6" class="text-right"><span class="total-label">Total Charge Amount</span></td>
            <td class="text-right"><span class="total-amount">PHP {{ totalChargeAmount | number:'1.2-2' }}</span></td>
            <td colspan="3"></td>
          </tr>
          <tr>
            <td colspan="6" class="text-right"><span class="total-label">Total Selling Amount</span></td>
            <td class="text-right"><span class="total-amount">PHP {{ totalSellingAmount | number:'1.2-2' }}</span></td>
            <td colspan="3"></td>
          </tr>
          <tr>
            <td colspan="6" class="text-right"><span class="total-label">Total Profit</span></td>
            <td class="text-right">
              <span class="total-amount"
                [style.color]="(totalSellingAmount - totalChargeAmount) >= 0 ? 'var(--green)' : 'var(--red)'">
                PHP {{ (totalSellingAmount - totalChargeAmount) | number:'1.2-2' }}
              </span>
            </td>
            <td colspan="3"></td>
          </tr>
        </tfoot>
        }
      </table>
    </div>

    <!-- Footer Count -->
    <div class="list-footer">
      <div class="footer-count">
        <strong>{{ filteredCharges.length }}</strong> charge(s) found
      </div>
    </div>
    }
  </div>
</div>


<!-- ── Add / Edit Modal ── -->
<!-- ── Add / Edit Modal ── -->
@if (showModal) {
  <div class="modal-backdrop" (click)="closeModal()"></div>
}
<div class="modal custom-modal" [class.show]="showModal" [class.d-block]="showModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" (click)="$event.stopPropagation()" role="document">
    <div class="modal-content">

      <!-- Header -->
      <div class="modal-header" style="background: #1a3a6b;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24" stroke="#fff" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
          <h5 class="modal-title" style="font-family: 'Sora', sans-serif; font-weight: 600; font-size: 15px; color: #fff; margin: 0;">
            @if (isEditMode) { Edit Charge } @else { Add New Charge }
          </h5>
          @if (isEditMode) {
            <span class="ref-chip" style="font-size: 10px; background: rgba(255,255,255,0.15); color: #fff; border-color: rgba(255,255,255,0.2);">
              Edit Mode
            </span>
          }
        </div>
        <button type="button" class="btn-close btn-close-white" (click)="closeModal()" aria-label="Close"></button>
      </div>

      <!-- Body -->
      <div class="modal-body" style="padding: 20px; display: flex; flex-direction: column; gap: 16px;">
        <form [formGroup]="chargeFormGroup">

          <!-- ── Section: Charge Info ── -->
          <div style="border: 1px solid var(--rule); border-radius: 8px; overflow: hidden;">
            <div style="padding: 8px 14px; background: var(--rule-light); border-bottom: 1px solid var(--rule);">
              <span class="cell-sub" style="font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Charge Info</span>
            </div>
            <div style="padding: 14px 16px; display: flex; flex-direction: column; gap: 12px;">

              <!-- Category -->
              <div class="position-relative category-dropdown">
                <label class="filter-label" style="margin-bottom: 6px; display: block;">
                  Category <span style="color: var(--red);">*</span>
                </label>
                <input type="text" class="filter-input" style="width: 100%;"
                  placeholder="Search or select category"
                  [value]="categorySearch"
                  (input)="onCategorySearchChange($any($event.target).value)"
                  (focus)="categoryDropdownOpen = true"
                  [disabled]="isEditMode"
                  [style.opacity]="isEditMode ? '0.5' : '1'"
                  [style.cursor]="isEditMode ? 'not-allowed' : 'text'" />
                @if (categoryDropdownOpen && filteredCategories.length > 0 && !isEditMode) {
                  <ul class="dropdown-list">
                    @for (category of filteredCategories; track category.chargeSubCategoryId) {
                      <li class="dropdown-item-custom" (click)="selectCategory(category)">
                        {{ category.chargeSubCategoryName }}
                      </li>
                    }
                  </ul>
                }
                @if (categoryDropdownOpen && filteredCategories.length === 0 && categorySearch && !isEditMode) {
                  <ul class="dropdown-list">
                    <li class="dropdown-item-custom" style="color: var(--ink-muted);">No categories found</li>
                  </ul>
                }
                <input type="hidden" formControlName="chargeSubCategoryId" />
                @if (chargeFormGroup.get('chargeSubCategoryId')?.invalid && chargeFormGroup.get('chargeSubCategoryId')?.touched) {
                  <div style="font-size: 11px; color: var(--red); margin-top: 4px;">Category is required</div>
                }
              </div>

              <!-- Description -->
              <div>
                <label class="filter-label" style="margin-bottom: 6px; display: block;">Description</label>
                <textarea class="filter-input"
                  style="width: 100%; resize: vertical; min-height: 80px; box-sizing: border-box;"
                  rows="3"
                  formControlName="description"
                  placeholder="Enter charge description..."
                  [style.opacity]="isEditMode ? '0.5' : '1'"
                  [style.pointer-events]="isEditMode ? 'none' : 'auto'"></textarea>
              </div>

            </div>
          </div>

          <!-- ── Section: Financial Details ── -->
          <div style="border: 1px solid var(--rule); border-radius: 8px; overflow: hidden;">
            <div style="padding: 8px 14px; background: var(--rule-light); border-bottom: 1px solid var(--rule);">
              <span class="cell-sub" style="font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">Financial Details</span>
            </div>
            <div style="padding: 14px 16px; display: flex; flex-direction: column; gap: 12px;">

              <!-- Currency + Rate -->
              <div style="display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: start;">
                <div>
                  <label class="filter-label" style="margin-bottom: 6px; display: block;">
                    Currency <span style="color: var(--red);">*</span>
                  </label>
                  <select class="filter-input" style="width: 100%;"
                    formControlName="currency"
                    [style.opacity]="isEditMode ? '0.5' : '1'"
                    [style.pointer-events]="isEditMode ? 'none' : 'auto'">
                    <option value="">Select currency...</option>
                    <option value="PHP">PHP — Philippine Peso</option>
                    <option value="USD">USD — US Dollar</option>
                    <option value="SGD">SGD — Singapore Dollar</option>
                    <option value="GBP">GBP — British Pound</option>
                    <option value="EUR">EUR — Euro</option>
                  </select>
                  @if (chargeFormGroup.get('currency')?.invalid && chargeFormGroup.get('currency')?.touched) {
                    <div style="font-size: 11px; color: var(--red); margin-top: 4px;">Currency is required</div>
                  }
                </div>
                <div style="width: 120px;">
                  <label class="filter-label" style="margin-bottom: 6px; display: block;">Rate to PHP</label>
                  <input type="number" class="filter-input" style="width: 100%; min-width: 0;"
                    formControlName="conversionRate" step="0.0001" placeholder="56.50" />
                  @if (chargeFormGroup.get('currency')?.value === 'PHP') {
                    <div style="font-size: 11px; color: var(--ink-muted); margin-top: 4px;">Default rate</div>
                  }
                </div>
              </div>

              <!-- Charge Amount + Selling Amount (side by side) -->
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div>
                  <label class="filter-label" style="margin-bottom: 6px; display: block;">
                    Charge Amount <span style="color: var(--red);">*</span>
                  </label>
                  <input type="number" class="filter-input" style="width: 100%;"
                    formControlName="amount" step="0.01" placeholder="0.00" />
                  @if (chargeFormGroup.get('amount')?.invalid && chargeFormGroup.get('amount')?.touched) {
                    <div style="font-size: 11px; color: var(--red); margin-top: 4px;">Valid charge amount is required</div>
                  }
                </div>
                <div>
                  <label class="filter-label" style="margin-bottom: 6px; display: block;">
                    Selling Amount <span style="color: var(--red);">*</span>
                  </label>
                  <input type="number" class="filter-input" style="width: 100%;"
                    formControlName="amountSelling" step="0.01" placeholder="0.00" />
                  @if (chargeFormGroup.get('amountSelling')?.invalid && chargeFormGroup.get('amountSelling')?.touched) {
                    <div style="font-size: 11px; color: var(--red); margin-top: 4px;">Valid selling amount is required</div>
                  }
                </div>
              </div>

            </div>
          </div>

          <!-- ── Section: Processing Flag ── -->
          <div style="border: 1px solid var(--rule); border-radius: 8px; overflow: hidden;"
            [style.opacity]="isEditMode ? '0.5' : '1'"
            [style.pointer-events]="isEditMode ? 'none' : 'auto'">
            <label style="display: flex; align-items: center; gap: 14px; padding: 14px 16px; cursor: pointer; margin: 0;">
              <input type="checkbox" formControlName="isForProcessing"
                style="width: 16px; height: 16px; accent-color: var(--accent); flex-shrink: 0;" />
              <div>
                <div style="font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 600; color: var(--ink);">
                  Is for processing
                </div>
                <div style="font-size: 11.5px; color: var(--ink-muted); margin-top: 2px; line-height: 1.4;">
                  Makes this charge available for processors to pick up and process.
                </div>
              </div>
            </label>
          </div>

        </form>
      </div>

      <!-- Footer -->
      <div class="modal-footer" style="border-top: 1px solid var(--rule); padding: 14px 20px; gap: 10px;">
        <button type="button" class="btn btn-ghost" (click)="closeModal()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="onSubmit()"
          [disabled]="!chargeFormGroup.valid || isSubmitting">
          @if (!isSubmitting) {
            {{ isEditMode ? 'Update Charge' : 'Create Charge' }}
          } @else {
            <span class="spinner-border spinner-border-sm me-2"></span>
            Submitting...
          }
        </button>
      </div>

    </div>
  </div>
</div>


<!-- ── Cancel Confirmation Modal ── -->
@if (showDeleteConfirmModal) {
<div class="modal-backdrop" (click)="closeDeleteConfirm()"></div>
}
<div class="modal custom-modal" [class.show]="showDeleteConfirmModal" [class.d-block]="showDeleteConfirmModal"
  tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()" role="document">
    <div class="modal-content">
      <div class="modal-header" style="background: var(--red); color: #fff;">
        <h5 class="modal-title" style="font-family: 'Sora', sans-serif; font-weight: 600; font-size: 16px;">
          Cancel Charge
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeDeleteConfirm()"
          aria-label="Close"></button>
      </div>

      <div class="modal-body" style="padding: 28px;">
        <div style="text-align: center; margin-bottom: 20px;">
          <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" fill="none" viewBox="0 0 24 24"
            stroke="var(--red)" stroke-width="1.5">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
          </svg>
        </div>

        <div class="confirm-notice" style="background: #fdecea; color: var(--red);">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
          </svg>
          This action cannot be undone!
        </div>

        <p style="text-align: center; font-size: 13.5px; color: var(--ink-soft); margin: 16px 0;">
          Are you sure you want to cancel this charge?
        </p>

        <div class="summary-card" style="border-color: #fdecea;">
          <div class="summary-card-title">Charge Details</div>
          <div class="summary-row">
            <span class="summary-key">Charge Code</span>
            <span class="summary-val">
              <span class="cell-mono" style="color: var(--accent);">{{ selectedCharge?.chargeCode }}</span>
            </span>
          </div>
          <div class="summary-row">
            <span class="summary-key">Category</span>
            <span class="summary-val">{{ selectedCharge?.chargeSubCategoryName }}</span>
          </div>
          <div class="summary-row">
            <span class="summary-key">Amount</span>
            <span class="summary-val" style="color: var(--red);">
              {{ selectedCharge?.currencyCode }} {{ selectedCharge?.amount | number:'1.2-2' }}
            </span>
          </div>
          @if (selectedCharge?.description) {
          <div class="summary-row">
            <span class="summary-key">Description</span>
            <span class="summary-val" style="font-size: 12px; font-weight: 400; color: var(--ink-muted);">
              {{ selectedCharge?.description }}
            </span>
          </div>
          }
        </div>
      </div>

      <div class="modal-footer" style="border-top: 1px solid var(--rule); padding: 16px 24px; gap: 10px;">
        <button type="button" class="btn btn-ghost" (click)="closeDeleteConfirm()">No, Keep It</button>
        <button type="button" class="btn btn-primary" style="background: var(--red);" (click)="confirmDelete()"
          [disabled]="isSubmitting">
          @if (!isSubmitting) { Yes, Cancel Charge }
          @else {
          <span class="spinner-border spinner-border-sm me-2"></span>
          Cancelling...
          }
        </button>
      </div>
    </div>
  </div>
</div>


<!-- ── Review Modal ── -->
@if (showReviewModal) {
<div class="modal-backdrop" (click)="closeReviewModal()"></div>
}
<div class="modal custom-modal" [class.show]="showReviewModal" [class.d-block]="showReviewModal" tabindex="-1"
  role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" (click)="$event.stopPropagation()" role="document">
    <div class="modal-content">
      <div class="modal-header" style="background: #1a3a6b; color: #fff;">
        <h5 class="modal-title" style="font-family: 'Sora', sans-serif; font-weight: 600; font-size: 16px;">
          Review Charge
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeReviewModal()"
          aria-label="Close"></button>
      </div>

      <div class="modal-body" style="padding: 24px;">
        <div class="summary-card" style="margin-bottom: 20px;">
          <div class="summary-card-title">Charge Details</div>
          <div class="summary-row">
            <span class="summary-key">Charge Code</span>
            <span class="summary-val cell-mono" style="color: var(--accent);">{{ selectedCharge?.chargeCode }}</span>
          </div>
          <div class="summary-row">
            <span class="summary-key">Category</span>
            <span class="summary-val">{{ selectedCharge?.chargeSubCategoryName }}</span>
          </div>
          <div class="summary-row">
            <span class="summary-key">Amount</span>
            <span class="summary-val" style="color: var(--accent);">
              {{ selectedCharge?.currencyCode }} {{ selectedCharge?.amount | number:'1.2-2' }}
            </span>
          </div>
          <div class="summary-row">
            <span class="summary-key">Amount Selling</span>
            <span class="summary-val" style="color: var(--green);">
              {{ selectedCharge?.currencyCode }} {{ selectedCharge?.amountSelling | number:'1.2-2' }}
            </span>
          </div>
          @if (selectedCharge?.description) {
          <div class="summary-row">
            <span class="summary-key">Description</span>
            <span class="summary-val" style="font-weight: 400; font-size: 12px;">{{ selectedCharge?.description
              }}</span>
          </div>
          }
        </div>

        <form [formGroup]="reviewFormGroup">
          <label class="filter-label" style="margin-bottom: 6px; display: block;">Approval / Rejection
            Comment(s)</label>
          <textarea class="filter-input" style="width: 100%; resize: vertical; min-height: 80px;" rows="3"
            formControlName="reviewRemarks" placeholder="Enter comment(s)..."></textarea>
        </form>

        <div class="confirm-notice" style="margin-top: 16px; background: #fef3e2; color: #92520a;">
          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="none" viewBox="0 0 24 24"
            stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10" />
            <path d="M12 8v4m0 4h.01" />
          </svg>
          Please review the charge details carefully before making a decision.
        </div>
      </div>

      <div class="modal-footer" style="border-top: 1px solid var(--rule); padding: 16px 24px; gap: 10px;">
        <button type="button" class="btn btn-ghost" (click)="closeReviewModal()">Cancel</button>
        <button type="button" class="btn btn-primary" style="background: var(--red);" (click)="rejectCharge()"
          [disabled]="isSubmitting">
          @if (!isSubmitting || reviewAction !== 'reject') { Reject }
          @else {
          <span class="spinner-border spinner-border-sm me-2"></span> Rejecting...
          }
        </button>
        <button type="button" class="btn btn-primary" style="background: var(--green);" (click)="approveCharge()"
          [disabled]="isSubmitting">
          @if (!isSubmitting || reviewAction !== 'approve') { Approve }
          @else {
          <span class="spinner-border spinner-border-sm me-2"></span> Approving...
          }
        </button>
      </div>
    </div>
  </div>
</div>


<!-- ── View / Audit Modal ── -->
@if (showViewModal) {
<div class="modal-backdrop" (click)="closeViewModal()"></div>
}
<div class="modal custom-modal" [class.show]="showViewModal" [class.d-block]="showViewModal" tabindex="-1"
  role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" (click)="$event.stopPropagation()" role="document">
    <div class="modal-content">
      <div class="modal-header" style="background: #1a3a6b; color: #fff;">
        <h5 class="modal-title" style="font-family: 'Sora', sans-serif; font-weight: 600; font-size: 16px;">
          Charge Transaction Details
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeViewModal()" aria-label="Close"></button>
      </div>

      <div class="modal-body" style="padding: 0;">

        <!-- Tab Nav -->
        <div
          style="display: flex; gap: 0; border-bottom: 1px solid var(--rule); background: var(--rule-light); padding: 0 20px;">
          <button class="view-tab" [class.active]="activeTab === 'details'" (click)="activeTab = 'details'"
            type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24"
              stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10" />
              <path d="M12 8v4m0 4h.01" />
            </svg>
            Details
          </button>
          <button class="view-tab" [class.active]="activeTab === 'audit'" (click)="activeTab = 'audit'" type="button">
            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="none" viewBox="0 0 24 24"
              stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Audit Log
          </button>
        </div>

        <div style="padding: 24px; max-height: 55vh; overflow-y: auto;">

          <!-- Details Tab -->
          @if (activeTab === 'details') {

          <div class="section-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="none" viewBox="0 0 24 24"
              stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10" />
              <path d="M12 8v4m0 4h.01" />
            </svg>
            Basic Information
          </div>
          <div class="summary-card" style="margin-bottom: 20px;">
            <div class="summary-row">
              <span class="summary-key">Charge Code</span>
              <span class="summary-val cell-mono" style="color: var(--accent);">{{ selectedCharge?.chargeCode }}</span>
            </div>
            <div class="summary-row">
              <span class="summary-key">Status</span>
              <span class="summary-val">
                <span class="status-chip" [ngClass]="getStatusClass(selectedCharge?.chargeTransactionStatus ?? '')">
                  {{ selectedCharge?.chargeTransactionStatus }}
                </span>
              </span>
            </div>
            <div class="summary-row">
              <span class="summary-key">Category</span>
              <span class="summary-val">{{ selectedCharge?.chargeCategoryName }}</span>
            </div>
            <div class="summary-row">
              <span class="summary-key">Sub-Category</span>
              <span class="summary-val">{{ selectedCharge?.chargeSubCategoryName }}</span>
            </div>
          </div>

          <div class="section-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="none" viewBox="0 0 24 24"
              stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Financial Information
          </div>
          <div class="summary-card" style="margin-bottom: 20px;">
            <div class="summary-row">
              <span class="summary-key">Currency</span>
              <span class="summary-val"><span class="ref-chip">{{ selectedCharge?.currencyCode }}</span></span>
            </div>
            <div class="summary-row">
              <span class="summary-key">Conversion Rate</span>
              <span class="summary-val cell-mono">{{ selectedCharge?.conversionRate | number:'1.4-4' }}</span>
            </div>
            <div class="summary-row">
              <span class="summary-key">Amount</span>
              <span class="summary-val" style="color: var(--accent);">{{ selectedCharge?.currencyCode }} {{
                selectedCharge?.amount | number:'1.2-2' }}</span>
            </div>
            <div class="summary-row">
              <span class="summary-key">Calculated (PHP)</span>
              <span class="summary-val"><span class="amount-positive">PHP {{ selectedCharge?.calculatedAmount |
                  number:'1.2-2' }}</span></span>
            </div>
            <div class="summary-row">
              <span class="summary-key">Amount Selling</span>
              <span class="summary-val" style="color: var(--green);">{{ selectedCharge?.currencyCode }} {{
                selectedCharge?.amountSelling | number:'1.2-2' }}</span>
            </div>
            <div class="summary-row">
              <span class="summary-key">Calculated Selling (PHP)</span>
              <span class="summary-val"><span class="amount-positive">PHP {{ selectedCharge?.calculatedSellingAmount |
                  number:'1.2-2' }}</span></span>
            </div>
          </div>

          @if (selectedCharge?.description) {
          <div class="section-title">
            <svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" fill="none" viewBox="0 0 24 24"
              stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h7" />
            </svg>
            Description
          </div>
          <div class="summary-card" style="margin-bottom: 20px;">
            <p style="font-size: 13px; color: var(--ink-soft); margin: 0;">{{ selectedCharge?.description }}</p>
          </div>
          }

          <div class="row g-3">
            <div class="col-md-6">
              <div class="section-title">Status Flags</div>
              <div class="summary-card">
                <div class="summary-row">
                  <span class="summary-key">Is Active</span>
                  <span class="summary-val">
                    <span class="status-chip" >
                      {{ selectedCharge?.isActive ? 'Yes' : 'No' }}
                    </span>
                  </span>
                </div>
                <div class="summary-row">
                  <span class="summary-key">For Processing</span>
                  <span class="summary-val">
                    <span class="status-chip" >
                      {{ selectedCharge?.isForProcessing ? 'Yes' : 'No' }}
                    </span>
                  </span>
                </div>
                <div class="summary-row">
                  <span class="summary-key">For Disbursement</span>
                  <span class="summary-val">
                    <span class="status-chip" >
                      {{ selectedCharge?.isForDisbursement ? 'Yes' : 'No' }}
                    </span>
                  </span>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="section-title">Audit Trail</div>
              <div class="summary-card">
                <div class="summary-row">
                  <span class="summary-key">Created By</span>
                  <span class="summary-val" style="font-size: 12px;">
                    {{ selectedCharge?.createdByName || 'N/A' }}<br />
                    <span style="font-weight: 400; color: var(--ink-muted);">{{ selectedCharge?.createdDate |
                      date:'MM/dd/yy h:mm a' }}</span>
                  </span>
                </div>
                @if (selectedCharge?.modifiedBy) {
                <div class="summary-row">
                  <span class="summary-key">Modified By</span>
                  <span class="summary-val" style="font-size: 12px;">
                    {{ selectedCharge?.modifiedByName || 'N/A' }}<br />
                    <span style="font-weight: 400; color: var(--ink-muted);">{{ selectedCharge?.modifiedDate |
                      date:'MM/dd/yy h:mm a' }}</span>
                  </span>
                </div>
                }
                @if (selectedCharge?.completedBy) {
                <div class="summary-row">
                  <span class="summary-key">Completed By</span>
                  <span class="summary-val" style="font-size: 12px;">{{ selectedCharge?.completedByName || 'N/A'
                    }}</span>
                </div>
                }
                @if (selectedCharge?.cancelledBy) {
                <div class="summary-row">
                  <span class="summary-key">Cancelled By</span>
                  <span class="summary-val" style="font-size: 12px;">{{ selectedCharge?.cancelledByName || 'N/A'
                    }}</span>
                </div>
                }
                <div class="summary-row">
                  <span class="summary-key">Processor</span>
                  <span class="summary-val" style="font-size: 12px;">{{ selectedCharge?.processorOwnerName || 'N/A'
                    }}</span>
                </div>
              </div>
            </div>
          </div>
          }

          <!-- Audit Log Tab -->
          @if (activeTab === 'audit') {
          @if (chargeAuditLogs && chargeAuditLogs.length > 0) {
          <div class="timeline">
            @for (log of chargeAuditLogs; track log.id) {
            <div class="timeline-item">
              <div class="timeline-marker" [ngClass]="getActionTypeClass(log.actionType)"></div>
              <div class="timeline-content">
                <div class="summary-card" style="margin-bottom: 12px;">
                  <div
                    style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                    <div>
                      <span class="status-chip" [ngClass]="getActionTypeBadge(log.actionType)">{{ log.actionType
                        }}</span>
                      <div class="cell-sub" style="margin-top: 4px;">
                        {{ (log.createDate + 'Z') | date:'MM/dd/yy h:mm a':'+0800' }}
                      </div>
                    </div>
                    <div style="text-align: right;">
                      <div class="cell-sub">Modified by</div>
                      <div class="cell-primary" style="font-size: 12px;">{{ log.modifiedBy }}</div>
                      @if (log.requestedBy) {
                      <div class="cell-sub">Req: {{ log.requestedBy }}</div>
                      }
                    </div>
                  </div>
                  <div style="display: flex; gap: 12px; flex-wrap: wrap; font-size: 12px;">
                    <div>
                      <div class="cell-sub">Status</div>
                      <div style="display: flex; align-items: center; gap: 4px; margin-top: 4px;">
                        @if (log.previousStatus) {
                        <span class="status-chip bg-secondary" style="font-size: 9px;">{{ log.previousStatus }}</span>
                        <span style="color: var(--ink-muted);">→</span>
                        }
                        <span class="status-chip" [ngClass]="getStatusClass(log.newStatus)" style="font-size: 9px;">{{
                          log.newStatus }}</span>
                      </div>
                    </div>
                    <div>
                      <div class="cell-sub">Amount</div>
                      <div class="cell-primary" style="margin-top: 4px;">{{ log.amount | number:'1.2-2' }}</div>
                    </div>
                    <div>
                      <div class="cell-sub">Code</div>
                      <div class="cell-mono" style="margin-top: 4px; color: var(--accent);">{{ log.chargeCode }}</div>
                    </div>
                  </div>
                  @if (log.remarks) {
                  <div
                    style="margin-top: 10px; padding: 8px 12px; background: var(--rule-light); border-radius: 6px; font-size: 12px; color: var(--ink-soft); border-left: 3px solid var(--rule);">
                    {{ log.remarks }}
                  </div>
                  }
                </div>
              </div>
            </div>
            }
          </div>
          } @else {
          <div class="empty-state">
            <div class="empty-icon">◻</div>
            <p>No audit log entries found for this transaction.</p>
          </div>
          }
          }
        </div>
      </div>

      <div class="modal-footer" style="border-top: 1px solid var(--rule); padding: 12px 20px;">
        <button type="button" class="btn btn-ghost" (click)="closeViewModal()">Close</button>
      </div>
    </div>
  </div>
</div>


<!-- ── Toast Notifications ── -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
  <div class="toast align-items-center border-0" [class.show]="showSuccessToast" role="alert">
    <div class="d-flex">
      <div class="toast-body rounded"
        style="background: var(--green-light); color: var(--green); display: flex; align-items: center; gap: 10px; font-size: 13px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24"
          stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
        </svg>
        <div><strong style="display: block;">Success!</strong>{{ successMessage }}</div>
      </div>
      <button type="button" class="btn-close me-2 m-auto" (click)="showSuccessToast = false"
        aria-label="Close"></button>
    </div>
  </div>
  <div class="toast align-items-center border-0" [class.show]="showErrorToast" role="alert">
    <div class="d-flex">
      <div class="toast-body rounded"
        style="background: #fdecea; color: var(--red); display: flex; align-items: center; gap: 10px; font-size: 13px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24"
          stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10" />
          <path d="m15 9-6 6M9 9l6 6" />
        </svg>
        <div><strong style="display: block;">Error</strong>{{ errorMessage }}</div>
      </div>
      <button type="button" class="btn-close me-2 m-auto" (click)="showErrorToast = false" aria-label="Close"></button>
    </div>
  </div>
</div>