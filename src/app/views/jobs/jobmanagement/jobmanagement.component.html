<div class="card my-4 shadow-sm">
  <div class="card-header bg-primary text-white">
    <div class="d-flex justify-content-between align-items-center">
      <div class="d-flex align-items-center gap-3">
        <h4 class="mb-0">
          <i class="bi bi-briefcase me-2"></i> Job Details
        </h4>
        <span class="badge badge-code">{{ job?.jobCode }}</span>
      </div>
      <div class="d-flex gap-2">
        <button routerLink="/jobs/list" class="btn btn-light-custom btn-sm">
          <i class="bi bi-arrow-left me-1"></i>
          <span>Back to List</span>
        </button>
        <button class="btn btn-light-custom btn-sm" (click)="printJobDetails()">
          <i class="bi bi-printer me-1"></i>
          <span>Print</span>
        </button>
      </div>
    </div>
  </div>

  <div class="card-body job-details-body">
    <div class="accordion accordion-custom" id="jobDetailsAccordion">

      <!-- ======================= 1. JOB INFORMATION ======================== -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingJobInfo">
          <button class="accordion-button" [class.collapsed]="!isSectionOpen('jobInfo')" type="button"
            (click)="toggleSection('jobInfo')" [attr.aria-expanded]="isSectionOpen('jobInfo')">
            <i class="bi bi-briefcase me-2"></i>
            Job Information
          </button>
        </h2>
        <div id="collapseJobInfo" class="accordion-collapse" [class.collapse]="!isSectionOpen('jobInfo')"
          [class.show]="isSectionOpen('jobInfo')">
          <div class="accordion-body">
            <div class="detail-section">
              <div class="row g-4">
                <div class="col-md-8">
                  <div class="detail-item">
                    <label class="detail-label">
                      <i class="bi bi-person"></i> Client
                    </label>
                    <div class="detail-value">{{ job?.customerName || '-' }}</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="detail-item">
                    <label class="detail-label">
                      <i class="bi bi-info-circle"></i> Status
                    </label>
                    <div class="detail-value">
                      <span [class]="'badge status-badge ' + getStatusBadgeClass(job?.jobStatusName || '')">
                        <i class="bi me-1" [ngClass]="getStatusIcon(job?.jobStatusName || '')"></i>
                        {{ job?.jobStatusName || 'Pending' }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="detail-section">
              <div class="row g-4">
                <div class="col-md-4">
                  <div class="detail-item">
                    <label class="detail-label">
                      <i class="bi bi-arrow-left-right"></i> Transaction Type
                    </label>
                    <div class="detail-value">{{ job?.transactionTypeName || '-' }}</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="detail-item">
                    <label class="detail-label">
                      <i class="bi bi-tags"></i> Incoterms
                    </label>
                    <div class="detail-value">{{ job?.incotermsName || '-' }}</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="detail-item">
                    <label class="detail-label">
                      <i class="bi bi-credit-card"></i> Payment Type
                    </label>
                    <div class="detail-value">{{ job?.paymentTypeName || '-' }}</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="detail-section">
              <div class="row g-4">
                <div class="col-md-6">
                  <div class="detail-item highlight-box">
                    <label class="detail-label">
                      <i class="bi bi-currency-dollar"></i> Amount
                    </label>
                    <div class="detail-value-large">₱{{ job?.amount | number:'1.2-2' }}</div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="detail-item">
                    <label class="detail-label">
                      <i class="bi bi-calendar"></i> Created Date
                    </label>
                    <div class="detail-value">{{ job?.createdDate | date:'MMM dd, yyyy' }}</div>
                  </div>
                </div>
              </div>
            </div>


            @if((userRole === 'SALES' || userRole === 'ADMIN') && job?.jobStatusName === 'FOR APPROVAL') {
            <div class="detail-section">
              <div class="row g-4">
                <div class="col-md-8">

                </div>
                <div class="col-md-4">
                  <div class="text-end">

                    <button class="btn btn-approve me-2" (click)="openApproveConfirm(job)">
                      <span>Approve</span>
                    </button>
                    <button class="btn btn-disapprove" (click)="openDisapproveConfirm(job)">
                      <span>Disapprove</span>
                    </button>
                  </div>
                </div>
              </div>
            </div>
            }

          </div>
        </div>
      </div>

      <!-- ======================= 2. CARGO & ROUTING DETAILS ======================== -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingCargo">
          <button class="accordion-button" [class.collapsed]="!isSectionOpen('cargo')" type="button"
            (click)="toggleSection('cargo')" [attr.aria-expanded]="isSectionOpen('cargo')">
            <i class="bi bi-box-seam me-2"></i>
            Cargo & Routing Details
          </button>
        </h2>
        <div id="collapseCargo" class="accordion-collapse" [class.collapse]="!isSectionOpen('cargo')"
          [class.show]="isSectionOpen('cargo')">
          <div class="accordion-body">
            <div class="detail-section">
              <h6 class="section-subtitle">
                <i class="bi bi-inbox"></i> Shipment Information
              </h6>
              <div class="row g-4">
                <div class="col-md-4">
                  <div class="detail-item">
                    <label class="detail-label">Commodity</label>
                    <div class="detail-value">{{ job?.commodity || '-' }}</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="detail-item">
                    <label class="detail-label">
                      <i class="bi bi-calendar-event"></i> Cut-off / LCT
                    </label>
                    <div class="detail-value">{{ job?.cutoff | date:'MMM dd, yyyy' }}</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="detail-item">
                    <label class="detail-label">Carrier</label>
                    <div class="detail-value">{{ job?.carrier || '-' }}</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="detail-section">
              <h6 class="section-subtitle">
                <i class="bi bi-geo-alt"></i> Routing Information
              </h6>
              <div class="row g-4">
                <div class="col-md-4">
                  <div class="detail-item">
                    <label class="detail-label">Origin</label>
                    <div class="detail-value">{{ job?.origin || '-' }}</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="detail-item">
                    <label class="detail-label">Destination</label>
                    <div class="detail-value">{{ job?.destination || '-' }}</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="detail-item">
                    <label class="detail-label">Port / CFS</label>
                    <div class="detail-value">{{ job?.portCfs || '-' }}</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="detail-section">
              <h6 class="section-subtitle">
                <i class="bi bi-bar-chart"></i> Measurements
              </h6>
              <div class="row g-4">
                <div class="col-md-4">
                  <div class="detail-item">
                    <label class="detail-label">Gross Weight</label>
                    <div class="detail-value">{{ job?.grossWeight || '-' }} kg</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="detail-item">
                    <label class="detail-label">Volume (CBM)</label>
                    <div class="detail-value">{{ job?.volume || '-' }} m³</div>
                  </div>
                </div>
                <div class="col-md-4">
                  <div class="detail-item">
                    <label class="detail-label">Number of Packages</label>
                    <div class="detail-value">{{ job?.numberOfPackages || '-' }}</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ======================= 3. FREIGHT DETAILS ======================== -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingFreight">
          <button class="accordion-button" [class.collapsed]="!isSectionOpen('freight')" type="button"
            (click)="toggleSection('freight')" [attr.aria-expanded]="isSectionOpen('freight')">
            <i class="bi bi-truck me-2"></i>
            Freight Details
          </button>
        </h2>
        <div id="collapseFreight" class="accordion-collapse" [class.collapse]="!isSectionOpen('freight')"
          [class.show]="isSectionOpen('freight')">
          <div class="accordion-body">
            @if (isSeaFreight()) {
            <div class="freight-section">
              <div class="freight-type-badge sea">
                <i class="bi bi-water"></i> Sea Freight
              </div>
              <div class="detail-section">
                <h6 class="section-subtitle">Bill of Lading References</h6>
                <div class="row g-4">
                  <div class="col-md-6">
                    <div class="detail-item">
                      <label class="detail-label">MBL Reference</label>
                      <div class="detail-value">{{ job?.mbl || '-' }}</div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="detail-item">
                      <label class="detail-label">HBL Reference</label>
                      <div class="detail-value">{{ job?.hbl || '-' }}</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="detail-section">
                <h6 class="section-subtitle">Vessel & Container Information</h6>
                <div class="row g-4">
                  <div class="col-md-6">
                    <div class="detail-item">
                      <label class="detail-label">Vessel</label>
                      <div class="detail-value">{{ job?.vessel || '-' }}</div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="detail-item">
                      <label class="detail-label">Container Size</label>
                      <div class="detail-value">{{ job?.containerCount || '-' }}</div>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="detail-item">
                      <label class="detail-label">Container Count</label>
                      <div class="detail-value">{{ job?.containerCount || '-' }}</div>
                    </div>
                  </div>
                </div>
              </div>
              @if (job?.containerCount) {
              <div class="detail-section">
                <div class="detail-item">
                  <label class="detail-label">Container Numbers</label>
                  <div class="detail-value">{{ job?.containerCount }}</div>
                </div>
              </div>
              }
            </div>
            }

            @if (isAirFreight()) {
            <div class="freight-section">
              <div class="freight-type-badge air">
                <i class="bi bi-airplane"></i> Air Freight
              </div>
              <div class="detail-section">
                <h6 class="section-subtitle">Air Waybill References</h6>
                <div class="row g-4">
                  <div class="col-md-6">
                    <div class="detail-item">
                      <label class="detail-label">MAWB Reference</label>
                      <div class="detail-value">{{ job?.mawb || '-' }}</div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="detail-item">
                      <label class="detail-label">HAWB Reference</label>
                      <div class="detail-value">{{ job?.hawb || '-' }}</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="detail-section">
                <h6 class="section-subtitle">Flight Information</h6>
                <div class="row g-4">
                  <div class="col-md-6">
                    <div class="detail-item">
                      <label class="detail-label">Flight No.</label>
                      <div class="detail-value">{{ job?.flightNo || '-' }}</div>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="detail-item">
                      <label class="detail-label">Chargeable Weight</label>
                      <div class="detail-value">{{ job?.chargeableWeight || '-' }} kg</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            }

            @if (!isSeaFreight() && !isAirFreight()) {
            <div class="empty-freight">
              <i class="bi bi-question-circle"></i>
              <p>No freight type specified</p>
            </div>
            }
          </div>
        </div>
      </div>

      <!-- ======================= 4. ADDITIONAL DETAILS ======================== -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingAdditional">
          <button class="accordion-button" [class.collapsed]="!isSectionOpen('additional')" type="button"
            (click)="toggleSection('additional')" [attr.aria-expanded]="isSectionOpen('additional')">
            <i class="bi bi-journal-text me-2"></i>
            Additional Details
          </button>
        </h2>
        <div id="collapseAdditional" class="accordion-collapse" [class.collapse]="!isSectionOpen('additional')"
          [class.show]="isSectionOpen('additional')">
          <div class="accordion-body">
            <div class="detail-section">
              <div class="row g-4">
                <div class="col-md-6">
                  <div class="detail-item">
                    <label class="detail-label">
                      <i class="bi bi-people"></i> Agent
                    </label>
                    <div class="detail-value">{{ job?.agent || '-' }}</div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="detail-item">
                    <label class="detail-label">Booking No.</label>
                    <div class="detail-value">{{ job?.bookingNo || '-' }}</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="detail-section">
              <div class="detail-item">
                <label class="detail-label">
                  <i class="bi bi-chat-left-text"></i> Remarks
                </label>
                <div class="detail-value remarks-box">
                       <div class="remarks-content">
                            {{ job?.remarks || 'No remarks' }}
                        </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ======================= 5. CHARGES & DISBURSEMENTS ======================== -->
      <div class="accordion-item">
        <h2 class="accordion-header" id="headingCharges">
          <button class="accordion-button" [class.collapsed]="!isSectionOpen('charges')" type="button"
            (click)="toggleSection('charges')" [attr.aria-expanded]="isSectionOpen('charges')">
            <i class="bi bi-cash-coin me-2"></i>
            Charges | Expenses | Disbursements
          </button>
        </h2>
        <div id="collapseCharges" class="accordion-collapse" [class.collapse]="!isSectionOpen('charges')"
          [class.show]="isSectionOpen('charges')">
          <div class="accordion-body p-0">
            <app-job-charges [charges]="charges" [jobGuid]="jobGuid" [userRole]="userRole" [jobStatus]="job?.jobStatusName || ''" [viewSummary]="true"></app-job-charges>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>


<!-- Approve Confirmation Modal -->
@if (showApproveConfirmModal) {
<div class="modal-backdrop" (click)="closeApproveConfirm()"></div>
}
<div class="modal custom-modal" [class.show]="showApproveConfirmModal" [class.d-block]="showApproveConfirmModal"
  tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()" role="document">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="cil-check-circle me-2"></i> Approve Charge
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeApproveConfirm()"
          aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-success" role="alert">
          <i class="cil-info me-2"></i>
          Please confirm your approval
        </div>
        <p class="mb-2">
          Are you sure you want to approve the job <strong>{{ selectedJob?.jobCode }}</strong>?
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeApproveConfirm()">
          <i class="cil-x me-2"></i> Cancel
        </button>
        <button type="button" class="btn btn-success" (click)="confirmApprove()" [disabled]="isSubmitting">
          @if (!isSubmitting) {
          <span>
            <i class="cil-check-circle me-2"></i> Approve Job
          </span>
          }
          @if (isSubmitting) {
          <span>
            <span class="spinner-border spinner-border-sm me-2"></span>
            Approving...
          </span>
          }
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Disapprove Confirmation Modal -->
@if (showDisapproveConfirmModal) {
<div class="modal-backdrop" (click)="closeDisapproveConfirm()"></div>
}
<div class="modal custom-modal" [class.show]="showDisapproveConfirmModal" [class.d-block]="showDisapproveConfirmModal"
  tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" (click)="$event.stopPropagation()" role="document">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">
          <i class="cil-x-circle me-2"></i> Disapprove Job
        </h5>
        <button type="button" class="btn-close btn-close-white" (click)="closeDisapproveConfirm()"
          aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-danger" role="alert">
          <i class="cil-warning me-2"></i>
          Please confirm your disapproval
        </div>
        <p class="mb-2">
          Are you sure you want to disapprove the job <strong>{{ selectedJob?.jobCode }}</strong>?
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeDisapproveConfirm()">
          <i class="cil-x me-2"></i> Cancel
        </button>
        <button type="button" class="btn btn-danger" (click)="confirmDisapprove()" [disabled]="isSubmitting">
          @if (!isSubmitting) {
          <span>
            <i class="cil-x-circle me-2"></i> Disapprove Job
          </span>
          }
          @if (isSubmitting) {
          <span>
            <span class="spinner-border spinner-border-sm me-2"></span>
            Disapproving...
          </span>
          }
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Toast Notifications -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
  <!-- Success Toast -->
  <div class="toast align-items-center border-0" [class.show]="showSuccessToast" role="alert" aria-live="assertive"
    aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body bg-success text-white rounded">
        <div class="d-flex align-items-center">
          <i class="bi bi-check-circle me-2" style="font-size: 1.5rem;"></i>
          <div>
            <strong class="d-block">Success!</strong>
            <span>{{ successMessage }}</span>
          </div>
        </div>
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" (click)="showSuccessToast = false"
        aria-label="Close"></button>
    </div>
  </div>

  <!-- Error Toast -->
  <div class="toast align-items-center border-0" [class.show]="showErrorToast" role="alert" aria-live="assertive"
    aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body bg-danger text-white rounded">
        <div class="d-flex align-items-center">
          <i class="bi bi-x-circle me-2" style="font-size: 1.5rem;"></i>
          <div>
            <strong class="d-block">Error</strong>
            <span>{{ errorMessage }}</span>
          </div>
        </div>
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" (click)="showErrorToast = false"
        aria-label="Close"></button>
    </div>
  </div>
</div>